<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title><%= dino.name %> - Détails</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="dino-details-body">

    <header class="hub-header">
        <div class="header-overlay">
            <div class="header-content">
                <div class="user-info">
                    <h1><%= pseudo %></h1>
                    <p class="status"><strong><%= role %></strong> des Guerriers du Givre depuis <%= daysMember %> jours</p>
                </div>

                <div class="nav-menu">
                    <a href="/dashboard" class="nav-btn" title="Accueil"><i class="fas fa-home"></i></a>
                    <a href="/clan" class="nav-btn" title="Mon Clan"><i class="fas fa-chess-rook"></i></a>
                    <a href="/plans" class="nav-btn" title="Plans"><i class="fas fa-scroll"></i></a>
                    <a href="#" class="nav-btn disabled" title="Travaux"><i class="fas fa-hammer"></i></a>
                </div>
            </div>
        </div>
    </header>

    <main class="dashboard-grid">
        
        <div class="col-left">
            <div class="identity-card">
                <div class="dino-avatar">
                <% if (dino.imageUrl) { %>
                    <img src="<%= dino.imageUrl %>" alt="<%= dino.name %>" class="dino-img">
                <% } else { %>
                    <img src="/img/<%= dino.race.toLowerCase() %>.png" alt="<%= dino.race %>" class="dino-img">
                <% } %>
                </div>
                <div class="dino-header-info">
                    <h2><%= dino.name %></h2>
                    <p><%= dino.race %> Niveau <%= dino.level %></p>
                </div>
            </div>

            
            <div class="stats-panel">
                <div class="stats-header" onclick="toggleStats()">
                     Statistiques <i class="fas fa-chevron-down" id="stats-icon" style="font-size: 0.8em; margin-left: 5px;"></i> 
                </div>
                
                <div class="stats-content hidden" id="dino-stats-content">
                    
                    <div class="stats-elements-row">
                        <div class="element-box">
                            <img src="/img/elements/fire.webp" class="element-img" alt="Feu">
                            <span class="element-val"><%= dino.statFire %></span>
                        </div>
                        <div class="element-box">
                            <img src="/img/elements/wood.webp" class="element-img" alt="Bois">
                            <span class="element-val"><%= dino.statWood %></span>
                        </div>
                        <div class="element-box">
                            <img src="/img/elements/water.webp" class="element-img" alt="Eau">
                            <span class="element-val"><%= dino.statWater %></span>
                        </div>
                        <div class="element-box">
                            <img src="/img/elements/lightning.webp" class="element-img" alt="Foudre">
                            <span class="element-val"><%= dino.statBolt %></span>
                        </div>
                        <div class="element-box">
                            <img src="/img/elements/air.webp" class="element-img" alt="Air">
                            <span class="element-val"><%= dino.statAir %></span>
                        </div>
                    </div>

                    <hr style="border-color: rgba(255,255,255,0.3);">
                    
                    <div class="stats-general-grid">
                        <div class="stat-line"><i class="fas fa-heart"></i> <%= dino.statLife %> PV</div>
                        <div class="stat-line"><i class="fas fa-hourglass-start"></i> <%= dino.statInitiative %> Init.</div>
                        <div class="stat-line"><i class="fas fa-shield-alt"></i> <%= dino.statArmor %>% Armure</div> 
                        <div class="stat-line"><i class="fas fa-running"></i> <%= dino.statSpeed %> Vit.</div>
                        <div class="stat-line"><i class="fas fa-hand-fist"></i> <%= dino.statCounter %>% Contre</div> 
                    </div>

                </div>
            </div>

            <div class="bottom-actions">
                <i class="fas fa-heart action-icon like"></i>
                <button class="icon-btn delete-btn"><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>

        <div class="col-center">
            <% if (dino.isReincarnate === 0) { %>
                <div class="mode-buttons">
                    <button class="btn-ice" id="btn-open-reincarnate">Réincarner</button>
                    <button class="btn-ice">Simulation</button>
                </div>
            <% } %>

            <div class="table-scroll" id="level-table-container">
                <table class="level-grid-table" id="progression-table">
                    <thead>
                        <tr>
                            <th class="col-level">NIV</th>
                            <th class="col-choice-header">CHOIX 1</th>
                            <th class="col-choice-header col-choice-2 hidden">CHOIX 2</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% for(let i = 1; i < 80; i++) { %>
                            <tr data-row-index="<%= i %>">
                                <td class="col-level"><%= i + 1 %></td>
                                
                                <td class="cell-choice col-1" onclick="toggleMenu(this)">
                                    <div class="cell-content">
                                        <span class="placeholder">-</span>
                                    </div>
                                    <div class="cell-menu">
                                        <img src="/img/elements/fire.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'fire')" title="Feu">
                                        <img src="/img/elements/wood.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'wood')" title="Bois">
                                        <img src="/img/elements/water.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'water')" title="Eau">
                                        <img src="/img/elements/lightning.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'lightning')" title="Foudre">
                                        <img src="/img/elements/air.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'air')" title="Air">
                                        
                                        <div class="menu-sep"></div>
                                        
                                        <div class="menu-icon text-badge bg-up" onclick="event.stopPropagation(); selectElement(this, 'up')" style="display:flex;align-items:center;justify-content:center;font-size:0.6rem;height:22px;">???</div>
                                        <div class="menu-icon text-badge bg-pdc btn-pdc-item" onclick="event.stopPropagation(); selectElement(this, 'pdc')" style="display:flex;align-items:center;justify-content:center;font-size:0.6rem;height:22px;">PDC</div>
                                    </div>
                                </td>

                                <td class="cell-choice col-2 hidden" onclick="toggleMenu(this)">
                                    <div class="cell-content">
                                        <span class="placeholder">-</span>
                                    </div>
                                    <div class="cell-menu">
                                        <img src="/img/elements/fire.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'fire')" title="Feu">
                                        <img src="/img/elements/wood.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'wood')" title="Bois">
                                        <img src="/img/elements/water.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'water')" title="Eau">
                                        <img src="/img/elements/lightning.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'lightning')" title="Foudre">
                                        <img src="/img/elements/air.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'air')" title="Air">
                                        
                                        <div class="menu-sep"></div>
                                        
                                        <div class="menu-icon text-badge bg-up" onclick="event.stopPropagation(); selectElement(this, 'up')" style="display:flex;align-items:center;justify-content:center;font-size:0.6rem;height:22px;">???</div>
                                        <div class="menu-icon text-badge bg-pdc btn-pdc-item" onclick="event.stopPropagation(); selectElement(this, 'pdc')" style="display:flex;align-items:center;justify-content:center;font-size:0.6rem;height:22px;">PDC</div>
                                    </div>
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="col-right">
            <button class="btn-ice">MES PLANS</button>
            
            <div class="plans-list">
                <div class="plan-row">
                    <div class="plan-icon fire"><img src="/img/elements/fire.webp" alt="Feu"></div>
                    <div class="plan-bar"></div>
                </div>
                <div class="plan-row">
                    <div class="plan-icon wood"><img src="/img/elements/wood.webp" alt="Bois"></div>
                    <div class="plan-bar"></div>
                </div>
                <div class="plan-row">
                    <div class="plan-icon water"><img src="/img/elements/water.webp" alt="Eau"></div>
                    <div class="plan-bar"></div>
                </div>
                <div class="plan-row">
                    <div class="plan-icon bolt"><img src="/img/elements/lightning.webp" alt="Foudre"></div>
                    <div class="plan-bar"></div>
                </div>
                <div class="plan-row">
                    <div class="plan-icon air"><img src="/img/elements/air.webp" alt="Air"></div>
                    <div class="plan-bar"></div>
                </div>
            </div>
        </div>

    </main>
    <div id="delete-modal" class="modal-overlay hidden">
        <div class="modal-box" style="border: 3px solid #C0392B;"> <h2 style="color: #C0392B;">Adieu Compagnon ?</h2>
            <p>Es-tu sûr de vouloir te séparer de <strong><%= dino.name %></strong> ?</p>
            <p style="font-size: 0.9rem; color: #666;">Cette action est irréversible. Il retournera au néant glacé.</p>
            
            <form action="/dinozs/delete" method="POST" style="margin-top: 20px;">
                <input type="hidden" name="dinozId" value="<%= dino.id %>">
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" id="cancel-delete">Annuler</button>
                    <button type="submit" class="btn-submit" style="background: #C0392B;">Confirmer la suppression</button>
                </div>
            </form>
        </div>
    </div>

    <div id="reincarnate-modal" class="modal hidden">
        <div class="modal-content ice-theme">
            <h2>Réincarnation</h2>
            <p>Le Dinoz va retomber <strong>Niveau 1</strong> et perdre sa progression de grille.</p>
            <p>En échange, répartissez <strong>5 points</strong> de bonus élémentaire :</p>

            <div class="points-distributor">
                <div class="points-remaining">Points restants : <span id="points-left">5</span></div>

                <% const elements = ['fire', 'wood', 'water', 'lightning', 'air']; %>
                <% const labels = ['Feu', 'Bois', 'Eau', 'Foudre', 'Air']; %>
                
                <% elements.forEach((elem, index) => { %>
                    <div class="distrib-row" data-element="<%= elem %>">
                        <img src="/img/elements/<%= elem %>.webp" class="mini-icon">
                        <span class="elem-name"><%= labels[index] %></span>
                        
                        <div class="counter-box">
                            <button class="btn-mini" onclick="updatePoints('<%= elem %>', -1)">-</button>
                            <span class="count-val" id="count-<%= elem %>">0</span>
                            <button class="btn-mini" onclick="updatePoints('<%= elem %>', 1)">+</button>
                        </div>
                    </div>
                <% }); %>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" id="cancel-reincarnate">Annuler</button>
                <button class="btn-confirm" id="confirm-reincarnate" disabled>Valider la Réincarnation</button>
            </div>
        </div>
    </div>

    <script>
    // --- ETAT GLOBAL ---
    let currentSelection = { row: null, col: null, cell: null };
    let hasPDC = false;
    
    document.addEventListener('DOMContentLoaded', () => {
        // --- CHARGEMENT : On injecte les données de 'ups' ici ---
        // Le <%- %> permet d'écrire le JSON brut directement dans le code JS
        const savedData = <%- dino.ups ? JSON.stringify(dino.ups) : '{}' %>;
        
        // 1. On restaure la grille visuellement
        restoreGrid(savedData);
        
        // 2. On lance le calcul du niveau et des verrous
        updateTableState(); 
    });

    // --- FONCTION RESTAURATION ---
    function restoreGrid(data) {
        // On parcourt chaque ligne sauvegardée
        for (const [rowIndex, cols] of Object.entries(data)) {
            // On cherche la ligne HTML correspondante (Attention aux index qui commencent à 1)
            const row = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
            if (!row) continue;

            // On applique visuellement les choix
            if (cols.col1) applyVisuals(row.querySelector('.col-1'), cols.col1);
            if (cols.col2) applyVisuals(row.querySelector('.col-2'), cols.col2);
        }
    }

    // Petit utilitaire pour éviter de répéter le code visuel
    function applyVisuals(cell, type) {
        if (!cell || !type) return;
        const contentDiv = cell.querySelector('.cell-content');
        
        // On stocke la valeur
        cell.dataset.value = type;
        
        // Nettoyage classes
        cell.className = cell.className.replace(/bg-\w+/g, "").trim(); 
        
        // Application Style + Contenu
        if (type === 'pdc') {
            cell.classList.add('bg-pdc');
            contentDiv.innerHTML = `<span class="text-badge">PDC</span>`;
        } else if (type === 'up') {
            cell.classList.add('bg-up');
            contentDiv.innerHTML = `<span class="text-badge">???</span>`;
        } else {
            cell.classList.add('bg-' + type);
            contentDiv.innerHTML = `<img src="/img/elements/${type}.webp" style="width:24px;">`;
        }
    }

    // --- GESTION DU MENU (CLIC) ---
    window.toggleMenu = function(cell) {
        if (cell.classList.contains('cell-locked')) return;

        const allMenus = document.querySelectorAll('.cell-menu');
        const currentMenu = cell.querySelector('.cell-menu');
        const wasOpen = currentMenu.classList.contains('visible');

        allMenus.forEach(m => m.classList.remove('visible'));

        if (!wasOpen) currentMenu.classList.add('visible');
    };

    document.addEventListener('click', function(event) {
        if (!event.target.closest('.cell-choice')) {
            document.querySelectorAll('.cell-menu').forEach(m => m.classList.remove('visible'));
        }
    });

    // --- SÉLECTIONNER UN ÉLÉMENT + SAUVEGARDE ---
    window.selectElement = function(el, type) {
        const cell = el.closest('.cell-choice');
        const row = cell.closest('tr');
        
        // Indices pour la sauvegarde
        const rowIndex = row.dataset.rowIndex;
        const colIndex = cell.classList.contains('col-1') ? 1 : 2;

        // 1. Application Visuelle
        applyVisuals(cell, type);

        // 2. Fermer le menu
        cell.querySelector('.cell-menu').classList.remove('visible');

        // 3. Recalculer la logique (PDC, niveaux...)
        updateTableState();

        // 4. SAUVEGARDE SILENCIEUSE VERS LE SERVEUR
        saveGridData(rowIndex, colIndex, type);
    };

    async function saveGridData(rowIndex, colIndex, value) {
        try {
            // On récupère l'ID du dino via EJS
            const dinoId = "<%= dino.id %>"; 
            
            await fetch('/dinoz/update-grid', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dinoId, rowIndex, colIndex, value })
            });
        } catch (err) {
            console.error("Erreur sauvegarde", err);
        }
    }

    // --- LOGIQUE SÉQUENTIELLE + PDC (INCHANGÉE) ---
    function updateTableState() {
        const rows = document.querySelectorAll('#progression-table tbody tr');
        let currentDinoLevel = 1; 
        let isRowUnlocked = true; 
        let pdcRowIndex = -1; 
        
        // Recherche de PDC
        rows.forEach((row, index) => {
            const val1 = row.querySelector('.col-1').dataset.value;
            const val2 = row.querySelector('.col-2').dataset.value;
            if (pdcRowIndex === -1 && (val1 === 'pdc' || val2 === 'pdc')) {
                pdcRowIndex = index;
            }
        });

        // Application des états
        rows.forEach((row, index) => {
            const cell1 = row.querySelector('.col-1');
            const cell2 = row.querySelector('.col-2');
            const th2 = document.querySelector('.col-choice-2'); 

            const isCol2Active = (pdcRowIndex !== -1 && index > pdcRowIndex);

            if (isCol2Active) {
                cell2.classList.remove('hidden');
                th2.classList.remove('hidden'); 
            } else {
                cell2.classList.add('hidden');
                if (pdcRowIndex === -1) th2.classList.add('hidden');
                // Si masqué, on ne vide PAS les données ici pour éviter de perdre la save serveur en cas de bug d'affichage
                // On cache juste visuellement
            }
            
            if (isRowUnlocked) {
                unlockCell(cell1);
                if (isCol2Active) unlockCell(cell2);
            } else {
                lockCell(cell1);
                lockCell(cell2);
            }

            const val1 = cell1.dataset.value;
            const val2 = cell2.dataset.value;
            let rowComplete = false;

            if (isCol2Active) {
                if (val1 && val2) rowComplete = true;
            } else {
                if (val1) rowComplete = true;
            }

            if (rowComplete) {
                currentDinoLevel++;
                isRowUnlocked = true;
            } else {
                isRowUnlocked = false; 
            }

            // Gestion boutons PDC
            const pdcBtns = row.querySelectorAll('.btn-pdc-item');
            pdcBtns.forEach(btn => {
                const parentVal = btn.closest('.cell-choice').dataset.value;
                if (pdcRowIndex === -1 || parentVal === 'pdc') {
                    btn.style.display = 'flex'; 
                } else {
                    btn.style.display = 'none';
                }
            });
        });

        const levelText = document.querySelector('.dino-header-info p');
        if(levelText) {
            const raceName = levelText.innerText.split(' Niveau')[0];
            levelText.innerText = `${raceName} Niveau ${currentDinoLevel}`;
        }
    }

    function lockCell(cell) { cell.classList.add('cell-locked'); }
    function unlockCell(cell) { cell.classList.remove('cell-locked'); }

    // (Code suppression inchangé)
    const deleteBtn = document.querySelector('.delete-btn');
    const deleteModal = document.getElementById('delete-modal');
    if(deleteBtn) deleteBtn.addEventListener('click', () => deleteModal.classList.remove('hidden'));
    const cancelBtn = document.getElementById('cancel-delete');
    if(cancelBtn) cancelBtn.addEventListener('click', () => deleteModal.classList.add('hidden'));

    // --- GESTION DU PANNEAU STATS ---
    window.toggleStats = function() {
        const content = document.getElementById('dino-stats-content');
        const icon = document.getElementById('stats-icon');
        
        // On bascule la classe 'hidden'
        const isHidden = content.classList.toggle('hidden');
        
        // Petit bonus visuel : on change l'icône (Flèche bas / Flèche haut)
        if (isHidden) {
            icon.className = 'fas fa-chevron-down';
        } else {
            icon.className = 'fas fa-chevron-up';
        }
    };

    // --- LOGIQUE RÉINCARNATION ---
    let bonusStats = { fire: 0, wood: 0, water: 0, lightning: 0, air: 0 };
    let pointsLeft = 5;

    // 1. Ouvrir / Fermer la modale
    const btnReincar = document.getElementById('btn-open-reincarnate');
    const modalReincar = document.getElementById('reincarnate-modal');
    const btnCancelReincar = document.getElementById('cancel-reincarnate');

    if (btnReincar) {
        btnReincar.addEventListener('click', () => {
            modalReincar.classList.remove('hidden');
            resetDistributor(); // Remise à zéro quand on ouvre
        });
    }
    
    if (btnCancelReincar) {
        btnCancelReincar.addEventListener('click', () => modalReincar.classList.add('hidden'));
    }

    // 2. Gestion des Compteurs (+/-)
    window.updatePoints = function(element, change) {
        // Si on veut ajouter mais qu'on n'a plus de points -> Stop
        if (change === 1 && pointsLeft <= 0) return;
        // Si on veut retirer mais qu'on est déjà à 0 -> Stop
        if (change === -1 && bonusStats[element] <= 0) return;

        // Mise à jour des valeurs
        bonusStats[element] += change;
        pointsLeft -= change;

        // Mise à jour de l'affichage HTML
        document.getElementById(`count-${element}`).innerText = bonusStats[element];
        document.getElementById('points-left').innerText = pointsLeft;

        // Gestion du bouton Valider (Actif seulement si 0 points restants)
        const btnConfirm = document.getElementById('confirm-reincarnate');
        if (pointsLeft === 0) {
            btnConfirm.disabled = false;
            btnConfirm.style.opacity = "1";
        } else {
            btnConfirm.disabled = true;
            btnConfirm.style.opacity = "0.5";
        }
    };

    function resetDistributor() {
        bonusStats = { fire: 0, wood: 0, water: 0, lightning: 0, air: 0 };
        pointsLeft = 5;
        // Reset visuel
        ['fire', 'wood', 'water', 'lightning', 'air'].forEach(el => {
            document.getElementById(`count-${el}`).innerText = "0";
        });
        document.getElementById('points-left').innerText = "5";
        document.getElementById('confirm-reincarnate').disabled = true;
    }

    // 3. Validation finale (Envoi au serveur)
    document.getElementById('confirm-reincarnate').addEventListener('click', async () => {
        try {
            const dinoId = "<%= dino.id %>";
            
            const response = await fetch('/dinoz/reincarnate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    dinoId: dinoId,
                    bonuses: bonusStats
                })
            });

            if (response.ok) {
                window.location.reload(); // On recharge pour voir le résultat
            } else {
                alert("Erreur lors de la réincarnation !");
            }
        } catch (err) {
            console.error(err);
        }
    });

</script>
</body>
</html>