<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title><%= dino.name %> - Détails</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="dino-details-body">

    <header class="hub-header">
        <div class="header-overlay">
            <div class="header-content">
                <div class="user-info">
                    <h1><%= pseudo %></h1>
                    <p class="status"><strong><%= role %></strong> des Guerriers du Givre depuis <%= daysMember %> jours</p>
                </div>

                <div class="nav-menu">
                    <a href="/dashboard" class="nav-btn" title="Accueil"><i class="fas fa-home"></i></a>
                    <a href="/dinozs" class="nav-btn" title="Mes Dinozs"><i class="fas fa-paw"></i></a>
                    <a href="/clan" class="nav-btn" title="Mon Clan"><i class="fas fa-chess-rook"></i></a>
                    <a href="/arbres" class="nav-btn" title="Plans"><i class="fas fa-scroll"></i></a>
                    <a href="#" class="nav-btn disabled" title="Travaux"><i class="fas fa-hammer"></i></a>
                </div>
            </div>
        </div>
    </header>

    <main class="dashboard-grid">
        
        <div class="col-left">
            <a href="/dinozs" class="btn-back-dino">
                <i class="fas fa-chevron-left"></i> Retour aux Dinozs
            </a>

            <div class="identity-card">
                <div class="dino-avatar">
                <% if (dino.imageUrl) { %>
                    <img src="<%= dino.imageUrl %>" alt="<%= dino.name %>" class="dino-img">
                <% } else { %>
                    <img src="/img/races/<%= dino.race.toLowerCase() %>.png" alt="<%= dino.race %>" class="dino-img">
                <% } %>
                </div>
                <div class="dino-header-info">
                    <h2><%= dino.name %></h2>
                    <p id="dino-level-display"><%= dino.race %> Niveau <%= dino.level %></p>
                </div>
            </div>

            <div class="stats-panel">
                <div class="stats-header" onclick="toggleStats()">
                     Statistiques <i class="fas fa-chevron-down" id="stats-icon" style="font-size: 0.8em; margin-left: 5px;"></i> 
                </div>
                <div class="stats-content hidden" id="dino-stats-content">
                    <div class="stats-elements-row">
                        <div class="element-box"><img src="/img/elements/fire.webp" class="element-img"><span class="element-val" id="val-fire"><%= dino.statFire %></span></div>
                        <div class="element-box"><img src="/img/elements/wood.webp" class="element-img"><span class="element-val" id="val-wood"><%= dino.statWood %></span></div>
                        <div class="element-box"><img src="/img/elements/water.webp" class="element-img"><span class="element-val" id="val-water"><%= dino.statWater %></span></div>
                        <div class="element-box"><img src="/img/elements/lightning.webp" class="element-img"><span class="element-val" id="val-bolt"><%= dino.statBolt %></span></div>
                        <div class="element-box"><img src="/img/elements/air.webp" class="element-img"><span class="element-val" id="val-air"><%= dino.statAir %></span></div>
                    </div>
                    <hr style="border-color: rgba(255,255,255,0.3);">
                    <div class="stats-general-grid">
                        <div class="stat-line"><i class="fas fa-heart"></i> <%= dino.statLife %> PV</div>
                        <div class="stat-line"><i class="fas fa-hourglass-start"></i> <%= dino.statInitiative %> Init.</div>
                        <div class="stat-line"><i class="fas fa-shield-alt"></i> <%= dino.statArmor %> Armure</div> 
                        <div class="stat-line"><i class="fas fa-running"></i> <%= dino.statSpeed %> Vit.</div>
                        <div class="stat-line"><i class="fas fa-hand-fist"></i> <%= dino.statCounter %>% Contre</div> 
                    </div>
                </div>
            </div>

            <div class="bottom-actions">
                <button class="btn-sacrifice" onclick="openDeleteModal()">
                    <i class="fas fa-skull"></i> Sacrifier
                </button>
            </div>
        </div>

        <div class="col-center" style="width: 550px;">
            <% if (dino.isReincarnate === 0) { %>
                <div class="mode-buttons">
                    <button class="btn-ice" id="btn-open-reincarnate">Réincarner</button>
                    <button class="btn-ice">Simulation</button>
                    <button class="btn-ice" id="btn-open-spheres">Sphères</button>
                </div>
            <% } %>

            <div class="table-scroll" id="level-table-container">
                <table class="level-grid-table" id="progression-table">
                    <thead>
                        <tr>
                            <th class="col-level">NIV</th>
                            <th class="col-choice-header">CHOIX 1</th>
                            <th class="col-choice-header col-choice-2 hidden">CHOIX 2</th>
                            <th class="col-decision-header">DÉCISION</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% for(let i = 1; i < 50; i++) { %>
                            <tr data-row-index="<%= i %>">
                                <td class="col-level"><%= i + 1 %></td>
                                
                                <td class="cell-choice col-1" onclick="toggleMenu(this)">
                                    <div class="cell-content"><span class="placeholder">-</span></div>
                                        <div class="cell-menu">
                                            <img src="/img/elements/fire.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'fire')" title="Feu">
                                            <img src="/img/elements/wood.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'wood')" title="Bois">
                                            <img src="/img/elements/water.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'water')" title="Eau">
                                            <img src="/img/elements/lightning.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'lightning')" title="Foudre">
                                            <img src="/img/elements/air.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'air')" title="Air">
                                            <div class="menu-sep"></div>
                                            <div class="menu-icon text-badge bg-up" onclick="event.stopPropagation(); selectElement(this, 'unknown')" title="Inconnu / ???" style="cursor:pointer; font-size:0.8rem;">???</div>
                                        </div>
                                </td>

                                <td class="cell-choice col-2 hidden" onclick="toggleMenu(this)">
                                    <div class="cell-content"><span class="placeholder">-</span></div>
                                        <div class="cell-menu">
                                            <img src="/img/elements/fire.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'fire')" title="Feu">
                                            <img src="/img/elements/wood.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'wood')" title="Bois">
                                            <img src="/img/elements/water.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'water')" title="Eau">
                                            <img src="/img/elements/lightning.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'lightning')" title="Foudre">
                                            <img src="/img/elements/air.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'air')" title="Air">
                                            <div class="menu-sep"></div>
                                            <div class="menu-icon text-badge bg-up" onclick="event.stopPropagation(); selectElement(this, 'unknown')" title="Inconnu / ???" style="cursor:pointer; font-size:0.8rem;">???</div>
                                        </div>
                                </td>

                                <td class="cell-choice cell-decision col-3" onclick="toggleMenu(this)">
                                    <div class="cell-content"><span class="placeholder">-</span></div>
                                </td>

                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="col-right">
            
            <div class="tabs-header">
                <button class="tab-btn active" onclick="openTab(event, 'tab-skills')">Compétences</button>
                <button class="tab-btn" onclick="openTab(event, 'tab-plans')">Mon Plan</button>
                <button class="tab-btn" onclick="openTab(event, 'tab-missions')">Missions</button>
            </div>

            <div id="tab-skills" class="tab-content active">
                <div class="skill-list-container">
                    </div>
            </div>

            <div id="tab-plans" class="tab-content">
                <div style="text-align:center; margin-top:50px; color:#89cff0;">
                    <i class="fas fa-hard-hat" style="font-size:3em; margin-bottom:15px;"></i>
                    <p>Plans Stratégiques</p>
                    <p style="font-size:0.8em; opacity:0.7;">Bientôt disponible</p>
                </div>
            </div>

            <div id="tab-missions" class="tab-content">
                <div style="text-align:center; margin-top:50px; color:#89cff0;">
                    <i class="fas fa-map-marked-alt" style="font-size:3em; margin-bottom:15px;"></i>
                    <p>Journal des Missions</p>
                    <p style="font-size:0.8em; opacity:0.7;">Bientôt disponible</p>
                </div>
            </div>

        </div>

    </main>

    <div id="delete-modal" class="modal-overlay hidden">
        <div class="modal-box" style="border: 3px solid #C0392B;"> 
            <h2 style="color: #C0392B;">Sacrifier le Dinoz ?</h2>
            <p>Es-tu sûr de vouloir sacrifier <strong><%= dino.name %></strong> aux Dieux du Givre ?</p>
            <p style="font-size: 0.9rem; color: #aaa;">Il sera transformé en ... rien du tout parce qu'il est trop nuuuuuul. <br><br> Cette action est irréversible !</p>
            
            <form action="/dinozs/delete" method="POST" style="margin-top: 20px;">
                <input type="hidden" name="dinozId" value="<%= dino.id %>">
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeDeleteModal()">Annuler</button>
                    <button type="submit" class="btn-submit" style="background: #C0392B;">Confirmer le Sacrifice</button>
                </div>
            </form>
        </div>
    </div>

    <div id="reincarnate-modal" class="modal-overlay hidden">
        <div class="ice-theme">
            <h2>Réincarnation</h2>
            <p>Le Dinoz va retomber <strong>Niveau 1</strong> et perdre sa progression de grille.</p>
            <p>En échange, répartissez <strong>5 points</strong> de bonus élémentaire :</p>

            <div class="points-distributor">
                <div class="points-remaining">Points restants : <span id="points-left">5</span></div>

                <% const elements = ['fire', 'wood', 'water', 'lightning', 'air']; %>
                <% const labels = ['Feu', 'Bois', 'Eau', 'Foudre', 'Air']; %>
                
                <% elements.forEach((elem, index) => { %>
                    <div class="distrib-row" data-element="<%= elem %>">
                        <div style="display:flex; align-items:center;">
                            <img src="/img/elements/<%= elem %>.webp" class="mini-icon">
                            <span class="elem-name"><%= labels[index] %></span>
                        </div>
                        <div class="counter-box">
                            <button class="btn-mini" onclick="updatePoints('<%= elem %>', -1)">-</button>
                            <span class="count-val" id="count-<%= elem %>">0</span>
                            <button class="btn-mini" onclick="updatePoints('<%= elem %>', 1)">+</button>
                        </div>
                    </div>
                <% }); %>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" id="cancel-reincarnate">Annuler</button>
                <button class="btn-confirm" id="confirm-reincarnate" disabled style="padding:10px; border-radius:5px; border:none;">Valider</button>
            </div>
        </div>
    </div>

    <div id="skill-selector-modal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; display:flex; justify-content:center; align-items:center;">
        <div style="background:#0c1a2b; border:2px solid #89cff0; padding:20px; width:400px; border-radius:10px; max-height:80vh; overflow-y:auto;">
            <h3 id="modal-skill-title" style="text-align:center; color:#89cff0; border-bottom:1px solid #333; padding-bottom:10px;">Choisir une compétence</h3>
            <div id="modal-skill-list" class="skill-list-container" style="margin-top:15px;"></div>
            <button class="btn-ice" style="margin-top:20px; width:100%;" onclick="closeSkillModal()">Annuler</button>
        </div>
    </div>

    <div id="spheres-modal" class="modal-overlay hidden">
        <div class="ice-theme" style="width: 550px;">
            <h2 style="color: #4fc3f7; text-align: center; margin-bottom: 20px;">Utiliser une Sphère Élémentaire</h2>
            <p style="text-align: center; font-size: 0.9em; margin-bottom: 20px; color: #aaa;">
                Ajoute une compétence unique. <br>
                <em>(Max 3 par élément)</em>
            </p>

            <div class="spheres-grid-selection" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 10px;">
                <% 
                   const spheresData = [
                       { id: 'fire', name: 'Feu', count: dino.sphereFire },
                       { id: 'wood', name: 'Bois', count: dino.sphereWood },
                       { id: 'water', name: 'Eau', count: dino.sphereWater },
                       { id: 'lightning', name: 'Foudre', count: dino.sphereBolt },
                       { id: 'air', name: 'Air', count: dino.sphereAir },
                       { id: 'void', name: 'Vide', count: dino.sphereVoid }
                   ];
                %>
                
                <% spheresData.forEach(s => { %>
                    <div class="sphere-option <%= s.count >= 3 ? 'disabled' : '' %>" 
                         onclick="<%= s.count >= 3 ? '' : `useSphere('${s.id}')` %>">
                        
                        <img src="/img/spheres/item_<%= s.id %>_sphere.webp" class="sphere-img" >
                        
                        <div class="sphere-label"><%= s.name %></div>
                        
                        <div class="sphere-dots">
                            <span class="dot <%= s.count >= 1 ? 'filled' : '' %>"></span>
                            <span class="dot <%= s.count >= 2 ? 'filled' : '' %>"></span>
                            <span class="dot <%= s.count >= 3 ? 'filled' : '' %>"></span>
                        </div>
                    </div>
                <% }); %>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeSpheresModal()">Fermer</button>
            </div>
        </div>
    </div>

    <div id="custom-alert-modal" class="modal-overlay hidden" style="z-index: 3000;">
        <div class="ice-theme" style="width: 400px; text-align: center; border: 2px solid #4fc3f7;">
            <h2 id="custom-alert-title" style="color: #4fc3f7; margin-bottom: 15px;">Notification</h2>
            
            <p id="custom-alert-message" style="color: white; margin-bottom: 25px; font-size: 1.1em;"></p>
            
            <button class="btn-ice" onclick="closeCustomAlert()" style="width: 100%;">Compris !</button>
        </div>
    </div>

    <div id="confirm-action-modal" class="modal-overlay hidden" style="z-index: 2500;">
        <div class="ice-theme" style="width: 450px; text-align: center; border: 2px solid #f39c12;">
            <h2 style="color: #f39c12; margin-bottom: 15px;">Confirmation Requise</h2>
            
            <p id="confirm-message" style="color: white; margin-bottom: 25px; font-size: 1.1em;">
                </p>

            <div style="display: flex; gap: 15px; justify-content: center;">
                <button class="btn-cancel" onclick="closeConfirmModal()">Annuler</button>
                <button class="btn-ice" id="btn-confirm-yes" style="background: linear-gradient(180deg, #f39c12, #d35400); border-color: #e67e22;">
                    Confirmer
                </button>
            </div>
        </div>
    </div>

<script>
    const ALL_SKILLS = <%- JSON.stringify(allSkills) %>;
    const SERVER_LEARNED_IDS = <%- JSON.stringify(dino.learnedSkills.map(s => s.id)) %>;
    const DINO_RACE = "<%= dino.race %>"; 

    // MAPPING
    const ELEM_MAP = { 
        'fire': 'Feu', 'wood': 'Bois', 'water': 'Eau', 'lightning': 'Foudre', 'air': 'Air',
        'unknown': 'Inconnu' 
    };
    const CSS_MAP = { 
        'Feu': 'fire', 'Bois': 'wood', 'Eau': 'water', 'Foudre': 'lightning', 'Air': 'air', 
        'Neutre': 'neutre', 'Vide': 'void',
        'Inconnu': 'up'
    };

    let localGrid = <%- dino.ups ? JSON.stringify(dino.ups) : '{}' %>;
    
    const PDC_SKILL = ALL_SKILLS.find(s => s.name === "Plan de Carrière" || s.name === "Plan de Carriere");
    const PDC_ID = PDC_SKILL ? PDC_SKILL.id : 41304; 

    document.addEventListener('DOMContentLoaded', () => {
        restoreGridVisuals();
        updateFullLogic();
    });

    // --- VISUEL ---

    function setCellVisual(cell, type) {
        const content = cell.querySelector('.cell-content');
        cell.dataset.value = type;
        cell.className = cell.className.replace(/bg-\w+/g, "").trim();
        
        if (type === 'unknown') {
            cell.classList.add('bg-up');
            content.innerHTML = '<span class="text-badge">???</span>';
        } else {
            cell.classList.add('bg-' + type);
            content.innerHTML = `<img src="/img/elements/${type}.webp" style="width:24px;">`;
        }
    }

    function setDecisionVisual(cell, data) {
        const content = cell.querySelector('.cell-content');
        cell.dataset.decision = JSON.stringify(data);
        cell.className = cell.className.replace(/bg-\w+/g, "").trim();

        if (data.action === 'unlock') {
            const cssElem = CSS_MAP[data.element] || 'neutre';
            cell.classList.add('bg-' + cssElem); 
            content.innerHTML = `<span class="text-badge" style="font-size:1.4em;">+</span>`;
        } else if (data.action === 'learn') {
            const skill = ALL_SKILLS.find(s => s.id === data.skillId);
            if(skill) {
                const cssElem = CSS_MAP[skill.element] || 'neutre';
                cell.classList.add('bg-' + cssElem);
                content.innerHTML = `<span style="font-size:0.75rem; font-weight:bold; line-height:1.1; padding:0 2px;">${skill.name}</span>`;
            }
        } else if (data.action === 'skip') {
            cell.classList.add('bg-up');
            content.innerHTML = `<span class="text-badge">${data.label}</span>`;
        }
    }

    function resetCell(cell) {
        const content = cell.querySelector('.cell-content');
        delete cell.dataset.decision;
        delete cell.dataset.value;
        cell.className = cell.className.replace(/bg-\w+/g, "").trim();
        content.innerHTML = '<span class="placeholder">-</span>';
    }

    // --- LOGIQUE PRINCIPALE (MOTEUR) ---
    function updateFullLogic() {
        const rows = document.querySelectorAll('#progression-table tbody tr');
        let state = { 
            learnedIds: new Set(SERVER_LEARNED_IDS), 
            pendingUnlocks: {}, 
            availableSkills: {}, 
            hasPDC: false 
        };

        // MODIF 1 : On laisse passer l'Arbre 2 (ne filtre que Sphères)
        const level1Skills = ALL_SKILLS.filter(s => 
            (!s.parents || s.parents.length === 0) && s.skillNature !== 3
        );

        ['Feu', 'Bois', 'Eau', 'Foudre', 'Air'].forEach(elem => {
            state.availableSkills[elem] = level1Skills.filter(s => s.element === elem).map(s => s.id);
            state.pendingUnlocks[elem] = new Set();
        });
        
        // Check PDC Global
        let doesPDCExistGlobally = false;
        rows.forEach(row => {
            const cell3 = row.querySelector('.col-3');
            if(cell3.dataset.decision && cell3.dataset.decision.includes(String(PDC_ID))) {
                doesPDCExistGlobally = true;
            }
        });

        rows.forEach((row, index) => {
            const cell1 = row.querySelector('.col-1');
            const cell2 = row.querySelector('.col-2');
            const cell3 = row.querySelector('.col-3');
            const rowIndex = row.dataset.rowIndex;

            // 1. Visibilité Colonne 2
            if (doesPDCExistGlobally) {
                document.querySelector('.col-choice-2').classList.remove('hidden');
                if (state.hasPDC) {
                    cell2.classList.remove('hidden');
                    cell2.style.visibility = 'visible';
                } else {
                    cell2.classList.remove('hidden');
                    cell2.style.visibility = 'hidden'; 
                    cell2.dataset.value = ""; 
                }
            } else {
                document.querySelector('.col-choice-2').classList.add('hidden');
                cell2.classList.add('hidden');
            }

            // 2. Vérif Décision (VALIDATION ROBUSTE AVEC LES 4 FILTRES)
            if (cell3.dataset.decision) {
                let isValid = false;
                try {
                    const dec = JSON.parse(cell3.dataset.decision);
                    
                    if (dec.action === 'skip') {
                        isValid = true; 
                    } else {
                        const val1DB = ELEM_MAP[cell1.dataset.value]; 
                        const val2DB = state.hasPDC ? ELEM_MAP[cell2.dataset.value] : null; 
                        const decElem = dec.element;

                        if (decElem && (decElem === val1DB || (state.hasPDC && decElem === val2DB))) {
                            if (dec.action === 'unlock') {
                                isValid = true;
                            } else if (dec.action === 'learn') {
                                // On vérifie si le parent est débloqué
                                if (state.availableSkills[decElem] && state.availableSkills[decElem].includes(dec.skillId)) {
                                    
                                    // AJOUT DES 4 FILTRES DE VALIDATION ICI
                                    const s = ALL_SKILLS.find(sk => sk.id === dec.skillId);
                                    let isAllowed = true;

                                    if (s) {
                                        // 1. Invocations
                                        if (s.type === 'I') isAllowed = false;

                                        // 2. Envol (Cas particulier multi-races)
                                        if (s.name === 'Envol') {
                                            const flyingRaces = ['planaille', 'nuageoz', 'pteroz', 'soufflet', 'pteroz demon'];
                                            if (!flyingRaces.includes(DINO_RACE.toLowerCase())) isAllowed = false;
                                        }

                                        // 3. Second Arbre
                                        if (s.skillNature === 2) isAllowed = false;

                                        // 4. Compétences Doubles
                                        if (s.element === 'Double') isAllowed = false;

                                        // 5. NOUVEAU : Filtre Race ID (Compétence exclusive)
                                        // Si la compétence demande une race spécifique et que ce n'est pas la nôtre
                                        if (s.raceId && s.raceId.toLowerCase() !== DINO_RACE.toLowerCase()) {
                                            isAllowed = false;
                                        }
                                    }
                                    if (isAllowed) isValid = true;
                                }
                            }
                        }
                    }
                } catch(e) {}

                if (!isValid) {
                    resetCell(cell3);
                    if(localGrid[rowIndex]) delete localGrid[rowIndex].col3;
                    saveGridData(rowIndex, 3, ""); 
                }
            }

            // 3. Auto-remplissage
            const val1 = cell1.dataset.value;
            const isRealElement = val1 && val1 !== 'unknown';
            
            if (isRealElement && !state.hasPDC && !cell3.dataset.decision) {
                setCellVisual(cell3, val1);
            } 

            // 4. Application Décision
            if (cell3.dataset.decision) {
                const dec = JSON.parse(cell3.dataset.decision);
                
                if (dec.action === 'learn') {
                    state.learnedIds.add(dec.skillId);
                    if (dec.skillId === PDC_ID) state.hasPDC = true;
                    
                    const dbElem = dec.element;
                    if (state.availableSkills[dbElem]) state.availableSkills[dbElem] = state.availableSkills[dbElem].filter(id => id !== dec.skillId);
                    
                    const skillData = ALL_SKILLS.find(s => s.id === dec.skillId);
                    if (skillData) {
                        // MODIF 2 : Propagation Arbre 2 autorisée
                        const children = ALL_SKILLS.filter(s => 
                            s.parents && s.parents.some(p => p.id === skillData.id) && s.skillNature !== 3
                        );
                        children.forEach(child => {
                            if (!state.pendingUnlocks[dbElem]) state.pendingUnlocks[dbElem] = new Set();
                            state.pendingUnlocks[dbElem].add(child.id);
                        });
                    }
                } else if (dec.action === 'unlock') {
                    const elem = dec.element;
                    if (state.pendingUnlocks[elem]) {
                        state.pendingUnlocks[elem].forEach(childId => {
                            if (!state.availableSkills[elem]) state.availableSkills[elem] = [];
                            state.availableSkills[elem].push(childId);
                        });
                        state.pendingUnlocks[elem].clear();
                    }
                }
            }
        });
        updateRightColumn(state.learnedIds);
    }

    // --- MODALE (LOGIQUE D'AFFICHAGE) ---

    function handleDecisionClick(cell) {
        const row = cell.closest('tr');
        const rowIndex = parseInt(row.dataset.rowIndex);
        const type1 = row.querySelector('.col-1').dataset.value;
        const type2 = row.querySelector('.col-2').dataset.value;
        
        let targetElements = new Set();
        if (type1 && ELEM_MAP[type1] && type1 !== 'unknown') targetElements.add(ELEM_MAP[type1]);
        
        const cell2 = row.querySelector('.col-2');
        const isCol2Active = !cell2.classList.contains('hidden') && cell2.style.visibility !== 'hidden';
        if (isCol2Active && type2 && ELEM_MAP[type2] && type2 !== 'unknown') {
            targetElements.add(ELEM_MAP[type2]);
        }

        const uniqueElementsList = Array.from(targetElements);
        const options = getAvailableOptionsAtRow(rowIndex, uniqueElementsList);
        
        options.push({ type: 'skip', label: '???', name: 'Inconnu' });
        openSkillModal(cell, options);
    }
    
    // Fonction qui recalcule l'état local juste pour la modale
    function getAvailableOptionsAtRow(targetRowIndex, elementsFilter) {
        let state = { learnedIds: new Set(), pendingUnlocks: {}, availableSkills: {} };
        
        // On laisse le moteur calculer tout sauf les Sphères (3)
        const level1Skills = ALL_SKILLS.filter(s => 
            (!s.parents || s.parents.length === 0) && s.skillNature !== 3
        );

        ['Feu', 'Bois', 'Eau', 'Foudre', 'Air'].forEach(elem => {
            state.availableSkills[elem] = level1Skills.filter(s => s.element === elem).map(s => s.id);
            state.pendingUnlocks[elem] = new Set();
        });

        // Replay de l'historique
        for (let i = 0; i < targetRowIndex; i++) {
            if (!localGrid[i] || !localGrid[i].col3) continue;
            try {
                const dec = JSON.parse(localGrid[i].col3);
                if (dec.action === 'learn') {
                    state.learnedIds.add(dec.skillId);
                    const dbElem = dec.element;
                    if (state.availableSkills[dbElem]) state.availableSkills[dbElem] = state.availableSkills[dbElem].filter(id => id !== dec.skillId);
                    
                    const skillData = ALL_SKILLS.find(s => s.id === dec.skillId);
                    if (skillData) {
                        // On propage les enfants (sauf Sphères)
                        const children = ALL_SKILLS.filter(s => 
                            s.parents && s.parents.some(p => p.id === skillData.id) && s.skillNature !== 3
                        );
                        children.forEach(child => {
                            if (!state.pendingUnlocks[dbElem]) state.pendingUnlocks[dbElem] = new Set();
                            state.pendingUnlocks[dbElem].add(child.id);
                        });
                    }
                } else if (dec.action === 'unlock') {
                    const elem = dec.element;
                    if (state.pendingUnlocks[elem]) {
                        state.pendingUnlocks[elem].forEach(childId => {
                            if (!state.availableSkills[elem]) state.availableSkills[elem] = [];
                            state.availableSkills[elem].push(childId);
                        });
                        state.pendingUnlocks[elem].clear();
                    }
                }
            } catch(e) {}
        }

        let options = [];
        elementsFilter.forEach(elem => {
            if (state.pendingUnlocks[elem] && state.pendingUnlocks[elem].size > 0) {
                options.push({ type: 'unlock', element: elem, count: state.pendingUnlocks[elem].size });
            }
            if (state.availableSkills[elem]) {
                state.availableSkills[elem].forEach(skillId => {
                    const s = ALL_SKILLS.find(sk => sk.id === skillId);
                    
                    if (s) {
                        let isAllowed = true;

                        // --- LES 4 FILTRES ---

                        // 1. Invocations
                        if (s.type === 'I') isAllowed = false;

                        // 2. Compétence Spéciale "Envol"
                        if (s.name === 'Envol') {
                            const flyingRaces = ['planaille', 'nuagoz', 'pteroz', 'soufflet', 'pteroz demon'];
                            if (!flyingRaces.includes(DINO_RACE.toLowerCase())) isAllowed = false;
                        }

                        // 3. Second Arbre (ex: Invocateur, etc.)
                        if (s.skillNature === 2) isAllowed = false;

                        // 4. Compétences Doubles (ex: Choc, Surcharge...)
                        if (s.element === 'Double') isAllowed = false;

                        // 5. Filtre Race ID (Compétence exclusive)
                        if (s.raceId && s.raceId.toLowerCase() !== DINO_RACE.toLowerCase()) {
                            isAllowed = false;
                        }

                        // Ajout si autorisé
                        if (isAllowed) {
                            options.push({ type: 'learn', skill: s, element: elem });
                        }
                    }
                });
            }
        });
        return options;
    }

    // --- UI HELPERS ---
    function openSkillModal(targetCell, options) {
        const modal = document.getElementById('skill-selector-modal');
        const list = document.getElementById('modal-skill-list');
        list.innerHTML = '';
        
        options.forEach(opt => {
            const item = document.createElement('div');
            
            if (opt.type === 'skip') {
                item.className = `skill-item list-neutre`;
                item.style.cursor = 'pointer';
                item.innerHTML = `
                    <div style="font-weight:bold; font-size:1.2em; width:30px; text-align:center;">${opt.label}</div>
                    <span>${opt.name}</span>
                `;
                item.onclick = () => confirmChoice(targetCell, { action: 'skip', label: opt.label });

            } else {
                const cssElem = CSS_MAP[opt.element] || 'neutre';
                item.className = `skill-item list-${cssElem}`;
                item.style.cursor = 'pointer';

                if (opt.type === 'unlock') {
                    item.innerHTML = `
                        <div style="font-weight:bold; font-size:1.5em; width:30px; text-align:center;">+</div>
                        <div style="display:flex; flex-direction:column;">
                            <span style="font-weight:bold;">Débloquer ${opt.element}</span>
                            <span style="font-size:0.8em; opacity:0.8;">${opt.count} en attente</span>
                        </div>
                    `;
                    item.onclick = () => confirmChoice(targetCell, { action: 'unlock', element: opt.element });
                } else {
                    item.innerHTML = `
                        <img src="/img/elements/${cssElem}.webp" class="skill-icon-small">
                        <span>${opt.skill.name}</span>
                        <span style="margin-left:auto; font-size:0.8em; opacity:0.6;">${opt.skill.type || ''}</span>
                    `;
                    item.onclick = () => confirmChoice(targetCell, { action: 'learn', skillId: opt.skill.id, element: opt.element });
                }
            }
            list.appendChild(item);
        });

        modal.classList.remove('hidden');
    }

    function confirmChoice(cell, data) {
        document.getElementById('skill-selector-modal').classList.add('hidden');
        setDecisionVisual(cell, data);
        const row = cell.closest('tr');
        if (!localGrid[row.dataset.rowIndex]) localGrid[row.dataset.rowIndex] = {};
        localGrid[row.dataset.rowIndex].col3 = JSON.stringify(data);
        saveGridData(row.dataset.rowIndex, 3, JSON.stringify(data));
        updateFullLogic();
    }

    function closeSkillModal() {
        document.getElementById('skill-selector-modal').classList.add('hidden');
    }

    function updateRightColumn(learnedIdsSet) {
        const container = document.querySelector('#tab-skills .skill-list-container');
        container.innerHTML = '';
        if (learnedIdsSet.size === 0) {
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">Aucune compétence.</div>';
            return;
        }

        const ORDER = ['Feu', 'Bois', 'Eau', 'Foudre', 'Air', 'Vide', 'Neutre'];
        
        let skillsList = [];
        learnedIdsSet.forEach(id => {
            const skill = ALL_SKILLS.find(s => s.id === id);
            if(skill) skillsList.push(skill);
        });

        skillsList.sort((a, b) => {
            const idxA = ORDER.indexOf(a.element);
            const idxB = ORDER.indexOf(b.element);
            if(idxA !== idxB) return idxA - idxB;
            return a.id - b.id;
        });

        skillsList.forEach(skill => {
            const cssElem = CSS_MAP[skill.element] || 'neutre';
            const div = document.createElement('div');
            div.className = `skill-item list-${cssElem}`;
            div.innerHTML = `
                <img src="/img/elements/${cssElem}.webp" class="skill-icon-small">
                <span>${skill.name}</span>
                <span style="margin-left:auto; font-size:0.7em;">${skill.type || ''}</span>
            `;
            container.appendChild(div);
        });
    }

    function restoreGridVisuals() {
        document.querySelectorAll('.cell-choice').forEach(cell => {
             cell.className = cell.className.replace(/bg-\w+/g, "").trim();
             cell.querySelector('.cell-content').innerHTML = '<span class="placeholder">-</span>';
             delete cell.dataset.value;
             delete cell.dataset.decision;
        });

        for (const [rowIndex, cols] of Object.entries(localGrid)) {
            const row = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
            if (!row) continue;
            if (cols.col1) setCellVisual(row.querySelector('.col-1'), cols.col1);
            if (cols.col2) setCellVisual(row.querySelector('.col-2'), cols.col2);
            if (cols.col3) {
                try {
                    const data = JSON.parse(cols.col3);
                    setDecisionVisual(row.querySelector('.col-3'), data);
                } catch(e) {}
            }
        }
    }

    async function saveGridData(rowIndex, colIndex, value) {
        try {
            const res = await fetch('/dinoz/update-grid', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dinoId: "<%= dino.id %>", rowIndex, colIndex, value })
            });
            const json = await res.json();
            if (json.success && json.stats) {
                document.getElementById('val-fire').innerText = json.stats.statFire;
                document.getElementById('val-wood').innerText = json.stats.statWood;
                document.getElementById('val-water').innerText = json.stats.statWater;
                document.getElementById('val-bolt').innerText = json.stats.statBolt;
                document.getElementById('val-air').innerText = json.stats.statAir;
                
                const lvlTxt = document.getElementById('dino-level-display');
                if(lvlTxt && json.level) {
                     lvlTxt.innerText = lvlTxt.innerText.replace(/Niveau \d+/, `Niveau ${json.level}`);
                }
            }
        } catch (err) { console.error(err); }
    }

    window.toggleMenu = function(cell) {
        if (cell.classList.contains('col-3')) {
            handleDecisionClick(cell);
        } else {
            if (cell.style.visibility === 'hidden') return;
            document.querySelectorAll('.cell-menu').forEach(m => m.classList.remove('visible'));
            cell.querySelector('.cell-menu').classList.add('visible');
        }
    };

    window.selectElement = function(el, type) {
        const cell = el.closest('.cell-choice');
        const row = cell.closest('tr');
        const colIndex = cell.classList.contains('col-2') ? 2 : 1;

        setCellVisual(cell, type);
        cell.querySelector('.cell-menu').classList.remove('visible');
        
        if (!localGrid[row.dataset.rowIndex]) localGrid[row.dataset.rowIndex] = {};
        localGrid[row.dataset.rowIndex][`col${colIndex}`] = type;
        
        saveGridData(row.dataset.rowIndex, colIndex, type);
        updateFullLogic(); 
    };

    function openTab(evt, tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        if(evt) evt.currentTarget.classList.add('active');
    }
    window.toggleStats = function() {
        const content = document.getElementById('dino-stats-content');
        const icon = document.getElementById('stats-icon');
        if(content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            icon.className = 'fas fa-chevron-up';
        } else {
            content.classList.add('hidden');
            icon.className = 'fas fa-chevron-down';
        }
    };
    window.openDeleteModal = function() { document.getElementById('delete-modal').classList.remove('hidden'); }
    window.closeDeleteModal = function() { document.getElementById('delete-modal').classList.add('hidden'); }

    // --- REINCARNATION ---
    let bonusStats = { fire: 0, wood: 0, water: 0, lightning: 0, air: 0 };
    let pointsLeft = 5;
    const btnReincar = document.getElementById('btn-open-reincarnate');
    const modalReincar = document.getElementById('reincarnate-modal');
    if (btnReincar) {
        btnReincar.addEventListener('click', () => {
            modalReincar.classList.remove('hidden');
            resetDistributor();
        });
    }
    document.getElementById('cancel-reincarnate')?.addEventListener('click', () => modalReincar.classList.add('hidden'));

    window.updatePoints = function(element, change) {
        if (change === 1 && pointsLeft <= 0) return;
        if (change === -1 && bonusStats[element] <= 0) return;
        
        bonusStats[element] += change;
        pointsLeft -= change;
        
        document.getElementById(`count-${element}`).innerText = bonusStats[element];
        document.getElementById('points-left').innerText = pointsLeft;
        
        const btnConfirm = document.getElementById('confirm-reincarnate');
        if (pointsLeft === 0) {
            btnConfirm.disabled = false;
            btnConfirm.style.opacity = "1";
            btnConfirm.style.cursor = "pointer";
            btnConfirm.style.background = "linear-gradient(180deg, #29b6f6, #0277bd)";
        } else {
            btnConfirm.disabled = true;
            btnConfirm.style.opacity = "0.5";
            btnConfirm.style.cursor = "not-allowed";
            btnConfirm.style.background = "#555";
        }
    };

    function resetDistributor() {
        bonusStats = { fire: 0, wood: 0, water: 0, lightning: 0, air: 0 };
        pointsLeft = 5;
        ['fire', 'wood', 'water', 'lightning', 'air'].forEach(el => {
            document.getElementById(`count-${el}`).innerText = "0";
        });
        document.getElementById('points-left').innerText = "5";
        const btnConfirm = document.getElementById('confirm-reincarnate');
        if(btnConfirm) {
            btnConfirm.disabled = true;
            btnConfirm.style.background = "#555";
        }
    }

    document.getElementById('confirm-reincarnate')?.addEventListener('click', async () => {
        try {
            const dinoId = "<%= dino.id %>";
            const response = await fetch('/dinoz/reincarnate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dinoId: dinoId, bonuses: bonusStats })
            });
            if (response.ok) window.location.reload();
            else alert("Erreur lors de la réincarnation !");
        } catch (err) { console.error(err); }
    });

    // --- GESTION SPHERES ---
    const modalSpheres = document.getElementById('spheres-modal');
    const btnSpheres = document.getElementById('btn-open-spheres');

    if(btnSpheres) {
        btnSpheres.addEventListener('click', () => {
            modalSpheres.classList.remove('hidden');
        });
    }

    window.closeSpheresModal = function() {
        modalSpheres.classList.add('hidden');
    }

    // --- SYSTEME D'ALERTE CUSTOM ---
    let reloadOnAlert = false;

    function showCustomAlert(title, message, reload = false) {
        document.getElementById('custom-alert-title').innerText = title;
        document.getElementById('custom-alert-message').innerText = message;
        reloadOnAlert = reload;
        document.getElementById('custom-alert-modal').classList.remove('hidden');
    }

    window.closeCustomAlert = function() {
        document.getElementById('custom-alert-modal').classList.add('hidden');
        if (reloadOnAlert) {
            window.location.reload();
        }
    }

    // --- GESTION SPHERES MISE À JOUR ---
    let pendingSphereElement = null; // Stocke l'élément en attente de validation

    // --- 1. FONCTION DÉCLENCHÉE AU CLIC SUR L'ICONE ---
    window.useSphere = function(element) {
        // On stocke l'élément choisi (ex: 'fire')
        pendingSphereElement = element;

        // On met à jour le texte de la modale
        const message = `Voulez-vous vraiment consommer une sphère <strong style="color:#4fc3f7">${element.toUpperCase()}</strong> ?<br><span style="font-size:0.8em; color:#aaa;">Cette action est définitive.</span>`;
        document.getElementById('confirm-message').innerHTML = message;

        // On ouvre la modale de confirmation
        document.getElementById('confirm-action-modal').classList.remove('hidden');
    };

    // --- 2. FONCTION POUR FERMER LA MODALE ---
    window.closeConfirmModal = function() {
        document.getElementById('confirm-action-modal').classList.add('hidden');
        pendingSphereElement = null; // On nettoie
    };

    // --- 3. FONCTION DÉCLENCHÉE QUAND ON CLIQUE SUR "OUI" ---
    document.getElementById('btn-confirm-yes').addEventListener('click', async () => {
        
        // CORRECTION : On récupère l'élément AVANT de fermer la modale
        const element = pendingSphereElement; 

        // Sécurité : si pas d'élément en attente, on arrête
        if (!element) return;

        // Maintenant on peut fermer (ce qui va remettre pendingSphereElement à null, mais on a sauvegardé 'element')
        closeConfirmModal();

        try {
            const dinoId = "<%= dino.id %>";
            const response = await fetch('/dinoz/add-sphere', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dinoId, element })
            });
            
            const json = await response.json();
            
            if (response.ok) {
                // FERMER LA MODALE DE SÉLECTION DES SPHÈRES
                if (typeof closeSpheresModal === 'function') closeSpheresModal();
                
                // AFFICHER LE SUCCÈS
                showCustomAlert(
                    "Sphère Consommée !", 
                    `Votre dinoz a appris la compétence ${json.skillName} !`, 
                    true // Reload = true
                );
            } else {
                showCustomAlert("Erreur", "Impossible d'utiliser la sphère : " + json.error, false);
            }
        } catch (err) {
            console.error(err);
            showCustomAlert("Erreur", "Problème technique avec le serveur.", false);
        }
    });
</script>
</body>
</html>