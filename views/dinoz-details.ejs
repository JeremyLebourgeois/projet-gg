<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title><%= dino.name %> - Détails</title>
    <link rel="icon" type="image/png" href="/img/logo.png">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/pages/arbres.css"> 
    <link rel="stylesheet" href="/css/pages/dinoz-details.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head

<body class="dino-details-body">

    <header class="hub-header">
        <div class="header-overlay">
            <div class="header-content">
                <div class="user-info">
                    <h1><%= pseudo %></h1>
                    <p class="status"><strong><%= role %></strong> des Guerriers du Givre depuis <%= daysMember %> jours</p>
                </div>

                <div class="nav-menu">
                    <a href="/dashboard" class="nav-btn" title="Accueil"><i class="fas fa-home"></i></a>
                    <a href="/dinozs" class="nav-btn" title="Mes Dinozs"><i class="fas fa-paw"></i></a>
                    <a href="/clan" class="nav-btn disabled" title="Mon Clan"><i class="fas fa-chess-rook"></i></a>
                    <a href="/arbres" class="nav-btn" title="Plans"><i class="fas fa-scroll"></i></a>
                    <a href="#" class="nav-btn disabled" title="Travaux"><i class="fas fa-hammer"></i></a>
                </div>
            </div>
        </div>
    </header>

    <main class="dashboard-grid">
        
        <div class="col-left">
            <a href="/dinozs" class="btn-back-dino">
                <i class="fas fa-chevron-left"></i> Retour aux Dinozs
            </a>

            <div class="identity-card">
                <div class="dino-avatar">
                <% if (dino.imageUrl) { %>
                    <img src="<%= dino.imageUrl %>" alt="<%= dino.name %>" class="dino-img">
                <% } else { %>
                    <img src="/img/races/<%= dino.race.toLowerCase() %>.png" alt="<%= dino.race %>" class="dino-img">
                <% } %>
                </div>
                <div class="dino-header-info">
                    <h2><%= dino.name %></h2>
                    <p id="dino-level-display"><%= dino.race %> Niveau <%= dino.level %></p>
                </div>
            </div>

            <div class="stats-panel">
                <div class="stats-header" onclick="toggleStats()">
                     Statistiques <i class="fas fa-chevron-down" id="stats-icon" style="font-size: 0.8em; margin-left: 5px;"></i> 
                </div>
                <div class="stats-content hidden" id="dino-stats-content">
                    <div class="stats-elements-row">
                        <div class="element-box"><img src="/img/elements/fire.webp" class="element-img"><span class="element-val" id="val-fire"><%= dino.statFire %></span></div>
                        <div class="element-box"><img src="/img/elements/wood.webp" class="element-img"><span class="element-val" id="val-wood"><%= dino.statWood %></span></div>
                        <div class="element-box"><img src="/img/elements/water.webp" class="element-img"><span class="element-val" id="val-water"><%= dino.statWater %></span></div>
                        <div class="element-box"><img src="/img/elements/lightning.webp" class="element-img"><span class="element-val" id="val-bolt"><%= dino.statBolt %></span></div>
                        <div class="element-box"><img src="/img/elements/air.webp" class="element-img"><span class="element-val" id="val-air"><%= dino.statAir %></span></div>
                    </div>
                    <hr style="border-color: rgba(255,255,255,0.3);">
                    <div class="stats-general-grid">
                        <div class="stat-line"><i class="fas fa-heart"></i> <%= dino.statLife %> PV</div>
                        <div class="stat-line"><i class="fas fa-hourglass-start"></i> <%= dino.statInitiative %> Init.</div>
                        <div class="stat-line"><i class="fas fa-shield-alt"></i> <%= dino.statArmor %> Armure</div> 
                        <div class="stat-line"><i class="fas fa-running"></i> <%= dino.statSpeed %> Vit.</div>
                        <div class="stat-line"><i class="fas fa-hand-fist"></i> <%= dino.statCounter %>% Contre</div> 
                    </div>
                </div>
            </div>

            <div class="bottom-actions">
                <button class="btn-sacrifice" onclick="openDeleteModal()">
                    <i class="fas fa-skull"></i> Sacrifier
                </button>
            </div>
        </div>

        <div class="col-center" style="width: 550px;">
            <div class =" mode-buttons">
                <% if (dino.isReincarnate === 0) { %>                        
                        <% if (hasReincarnationSkill) { %>
                            <button class="btn-ice" id="btn-open-reincarnate" style="border-color: #f1c40f; color: #f1c40f;">  Réincarner </button>
                        <% } %>
                <% } %>
                <button class="btn-ice">Simulation</button>
                <button class="btn-ice" id="btn-open-spheres">Sphères</button>
            </div>
            
        
           

            <div class="table-scroll" id="level-table-container">
                <table class="level-grid-table" id="progression-table">
                    <thead>
                        <tr>
                            <th class="col-level">NIV</th>
                            <th class="col-choice-header">CHOIX 1</th>
                            <th class="col-choice-header col-choice-2 hidden">CHOIX 2</th>
                            <th class="col-decision-header">DÉCISION</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% for(let i = 1; i < 50; i++) { %>
                            <tr data-row-index="<%= i %>">
                                <td class="col-level"><%= i + 1 %></td>
                                
                                <td class="cell-choice col-1" onclick="toggleMenu(this)">
                                    <div class="cell-content"><span class="placeholder">-</span></div>
                                        <div class="cell-menu">
                                            <img src="/img/elements/fire.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'fire')" title="Feu">
                                            <img src="/img/elements/wood.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'wood')" title="Bois">
                                            <img src="/img/elements/water.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'water')" title="Eau">
                                            <img src="/img/elements/lightning.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'lightning')" title="Foudre">
                                            <img src="/img/elements/air.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'air')" title="Air">
                                            <div class="menu-sep"></div>
                                            <div class="menu-icon text-badge bg-up" onclick="event.stopPropagation(); selectElement(this, 'unknown')" title="Inconnu / ???" style="cursor:pointer; font-size:0.8rem;">???</div>
                                        </div>
                                </td>

                                <td class="cell-choice col-2 hidden" onclick="toggleMenu(this)">
                                    <div class="cell-content"><span class="placeholder">-</span></div>
                                        <div class="cell-menu">
                                            <img src="/img/elements/fire.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'fire')" title="Feu">
                                            <img src="/img/elements/wood.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'wood')" title="Bois">
                                            <img src="/img/elements/water.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'water')" title="Eau">
                                            <img src="/img/elements/lightning.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'lightning')" title="Foudre">
                                            <img src="/img/elements/air.webp" class="menu-icon" onclick="event.stopPropagation(); selectElement(this, 'air')" title="Air">
                                            <div class="menu-sep"></div>
                                            <div class="menu-icon text-badge bg-up" onclick="event.stopPropagation(); selectElement(this, 'unknown')" title="Inconnu / ???" style="cursor:pointer; font-size:0.8rem;">???</div>
                                        </div>
                                </td>

                                <td class="cell-choice cell-decision col-3" onclick="toggleMenu(this)">
                                    <div class="cell-content"><span class="placeholder">-</span></div>
                                </td>

                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="col-right">
            
            <div class="tabs-header">
                <button class="tab-btn active" onclick="openTab(event, 'tab-skills')">Compétences</button>
                <button class="tab-btn" onclick="openTab(event, 'tab-plans')">Mon Plan</button>
                <button class="tab-btn" onclick="openTab(event, 'tab-missions')">Missions</button>
            </div>

            <div id="tab-skills" class="tab-content active">
                <div class="skill-list-container"></div>
            </div>

            <div id="tab-plans" class="tab-content">
                <div class="details-card" style="border:none; padding:0; background:transparent; box-shadow:none;">
                    
                    <div id="plan-widget-content">
                        <% if (dino.plan) { %>
                            <div class="mini-plan-card">
                                <div class="mini-plan-header">
                                    <span class="mini-plan-race"><%= dino.plan.race %></span>
                                    <span class="mini-plan-lvl">Obj. Niv <%= dino.plan.level %></span>
                                </div>
                                <div class="mini-plan-title"><%= dino.plan.name %></div>
                                
                                <div class="mini-plan-actions">
                                    <a href="/plan/<%= dino.plan.id %>" class="btn-mini" title="Voir en grand"><i class="fas fa-eye"></i></a>
                                    <button onclick="openPlanModal()" class="btn-mini" title="Changer"><i class="fas fa-exchange-alt"></i></button>
                                    <button onclick="removePlan()" class="btn-mini delete" title="Retirer"><i class="fas fa-times"></i></button>
                                </div>
                            </div>

                            <div id="mini-trees-container" class="mini-trees-scroll"></div>

                        <% } else { %>
                            <div class="no-plan-box" onclick="openPlanModal()" style="margin-top:50px;">
                                <i class="fas fa-plus-circle" style="font-size: 3rem; margin-bottom: 15px; color: #4fc3f7;"></i>
                                <div style="font-size:1.2em; font-weight:bold;">Assigner un plan</div>
                                <div style="color:#aaa; font-size:0.9em; margin-top:5px;">Définir une stratégie pour ce Dinoz</div>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <div id="tab-missions" class="tab-content">
                <div style="text-align:center; margin-top:50px; color:#89cff0;">
                    <i class="fas fa-map-marked-alt" style="font-size:3em; margin-bottom:15px;"></i>
                    <p>Journal des Missions</p>
                    <p style="font-size:0.8em; opacity:0.7;">Bientôt disponible</p>
                </div>
            </div>

        </div>

    </main>

    <div id="delete-modal" class="modal-overlay hidden">
        <div class="modal-box" style="border: 3px solid #C0392B;"> 
            <h2 style="color: #C0392B;">Sacrifier le Dinoz ?</h2>
            <p>Es-tu sûr de vouloir sacrifier <strong><%= dino.name %></strong> aux Dieux du Givre ?</p>
            <p style="font-size: 0.9rem; color: #aaa;">Il sera transformé en ... rien du tout parce qu'il est trop nuuuuuul. <br><br> Cette action est irréversible !</p>
            
            <form action="/dinozs/delete" method="POST" style="margin-top: 20px;">
                <input type="hidden" name="dinozId" value="<%= dino.id %>">
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeDeleteModal()">Annuler</button>
                    <button type="submit" class="btn-submit" style="background: #C0392B;">Confirmer le Sacrifice</button>
                </div>
            </form>
        </div>
    </div>

    <div id="reincarnate-modal" class="modal-overlay hidden">
        <div class="ice-theme">
            <h2>Réincarnation</h2>
            <p>Le Dinoz va retomber <strong>Niveau 1</strong> et perdre sa progression de grille.</p>
            <p>En échange, répartissez <strong>5 points</strong> de bonus élémentaire :</p>

            <div class="points-distributor">
                <div class="points-remaining">Points restants : <span id="points-left">5</span></div>

                <% const elements = ['fire', 'wood', 'water', 'lightning', 'air']; %>
                <% const labels = ['Feu', 'Bois', 'Eau', 'Foudre', 'Air']; %>
                
                <% elements.forEach((elem, index) => { %>
                    <div class="distrib-row" data-element="<%= elem %>">
                        <div style="display:flex; align-items:center;">
                            <img src="/img/elements/<%= elem %>.webp" class="mini-icon">
                            <span class="elem-name"><%= labels[index] %></span>
                        </div>
                        <div class="counter-box">
                            <button class="btn-mini" onclick="updatePoints('<%= elem %>', -1)">-</button>
                            <span class="count-val" id="count-<%= elem %>">0</span>
                            <button class="btn-mini" onclick="updatePoints('<%= elem %>', 1)">+</button>
                        </div>
                    </div>
                <% }); %>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" id="cancel-reincarnate">Annuler</button>
                <button class="btn-confirm" id="confirm-reincarnate" disabled style="padding:10px; border-radius:5px; border:none;">Valider</button>
            </div>
        </div>
    </div>

    <div id="skill-selector-modal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; display:flex; justify-content:center; align-items:center;">
        <div style="background:#0c1a2b; border:2px solid #89cff0; padding:20px; width:400px; border-radius:10px; max-height:80vh; overflow-y:auto;">
            <h3 id="modal-skill-title" style="text-align:center; color:#89cff0; border-bottom:1px solid #333; padding-bottom:10px;">Choisir une compétence</h3>
            <div id="modal-skill-list" class="skill-list-container" style="margin-top:15px;"></div>
            <button class="btn-ice" style="margin-top:20px; width:100%;" onclick="closeSkillModal()">Annuler</button>
        </div>
    </div>

    <div id="spheres-modal" class="modal-overlay hidden">
        <div class="ice-theme" style="width: 550px;">
            <h2 style="color: #4fc3f7; text-align: center; margin-bottom: 20px;">Utiliser une Sphère Élémentaire</h2>
            <p style="text-align: center; font-size: 0.9em; margin-bottom: 20px; color: #aaa;">
                Ajoute une compétence unique. <br>
                <em>(Max 3 par élément)</em>
            </p>

            <div class="spheres-grid-selection" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 10px;">
                <% 
                   const spheresData = [
                       { id: 'fire', name: 'Feu', count: dino.sphereFire },
                       { id: 'wood', name: 'Bois', count: dino.sphereWood },
                       { id: 'water', name: 'Eau', count: dino.sphereWater },
                       { id: 'lightning', name: 'Foudre', count: dino.sphereBolt },
                       { id: 'air', name: 'Air', count: dino.sphereAir },
                       { id: 'void', name: 'Vide', count: dino.sphereVoid }
                   ];
                %>
                
                <% spheresData.forEach(s => { %>
                    <div class="sphere-option <%= s.count >= 3 ? 'disabled' : '' %>" 
                         onclick="<%= s.count >= 3 ? '' : `useSphere('${s.id}')` %>">
                        
                        <img src="/img/spheres/item_<%= s.id %>_sphere.webp" class="sphere-img" >
                        
                        <div class="sphere-label"><%= s.name %></div>
                        
                        <div class="sphere-dots">
                            <span class="dot <%= s.count >= 1 ? 'filled' : '' %>"></span>
                            <span class="dot <%= s.count >= 2 ? 'filled' : '' %>"></span>
                            <span class="dot <%= s.count >= 3 ? 'filled' : '' %>"></span>
                        </div>
                    </div>
                <% }); %>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeSpheresModal()">Fermer</button>
            </div>
        </div>
    </div>

    <div id="custom-alert-modal" class="modal-overlay hidden" style="z-index: 3000;">
        <div class="ice-theme" style="width: 400px; text-align: center; border: 2px solid #4fc3f7;">
            <h2 id="custom-alert-title" style="color: #4fc3f7; margin-bottom: 15px;">Notification</h2>
            
            <p id="custom-alert-message" style="color: white; margin-bottom: 25px; font-size: 1.1em;"></p>
            
            <button class="btn-ice" onclick="closeCustomAlert()" style="width: 100%;">Compris !</button>
        </div>
    </div>

    <div id="confirm-action-modal" class="modal-overlay hidden" style="z-index: 2500;">
        <div class="ice-theme" style="width: 450px; text-align: center; border: 2px solid #f39c12;">
            <h2 style="color: #f39c12; margin-bottom: 15px;">Confirmation Requise</h2>
            
            <p id="confirm-message" style="color: white; margin-bottom: 25px; font-size: 1.1em;">
                </p>

            <div style="display: flex; gap: 15px; justify-content: center;">
                <button class="btn-cancel" onclick="closeConfirmModal()">Annuler</button>
                <button class="btn-ice" id="btn-confirm-yes" style="background: linear-gradient(180deg, #f39c12, #d35400); border-color: #e67e22;">
                    Confirmer
                </button>
            </div>
        </div>
    </div>

    <div id="plan-selection-modal" class="modal-overlay hidden">
        <div class="ice-theme" style="width: 450px;">
            <h2 style="color: #4fc3f7; text-align: center; border-bottom: 1px solid #555; padding-bottom: 10px;">
                Choisir un Plan
            </h2>
            
            <div class="plans-list-scroll">
                <% if (myPlans.length === 0) { %>
                    <p style="text-align:center; color:#aaa; padding:20px;">
                        Aucun plan disponible.<br>
                        <a href="/architecte" style="color:#4fc3f7;">Créer un plan</a>
                    </p>
                <% } else { %>
                    <div class="plan-select-item" onclick="assignPlan(null)">
                        <span style="color:#aaa;">Aucun Plan (Retirer)</span>
                    </div>

                    <% myPlans.forEach(p => { %>
                        <div class="plan-select-item" onclick="assignPlan(<%= p.id %>)">
                            <div>
                                <strong style="color:white;"><%= p.name %></strong>
                                <div style="font-size:0.8em; color:#888;"><%= p.race %> - Niv. <%= p.level %></div>
                            </div>
                            <i class="fas fa-chevron-right" style="color:#4fc3f7;"></i>
                        </div>
                    <% }) %>
                <% } %>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="document.getElementById('plan-selection-modal').classList.add('hidden')">Annuler</button>
            </div>
        </div>
    </div>
    <div id="skill-tooltip"></div>

    <script>
        const DINO_DATA = {
            allSkills: <%- JSON.stringify(allSkills) %>,
            serverLearnedIds: <%- JSON.stringify(dino.learnedSkills.map(s => s.id)) %>,
            race: "<%= dino.race %>",
            grid: <%- dino.ups ? JSON.stringify(dino.ups) : '{}' %>,
            id: "<%= dino.id %>",
            planIds: <%- (dino.plan && dino.plan.skillIds) ? JSON.stringify(dino.plan.skillIds) : '[]' %>
        };
    </script>

    <script src="/js/pages/dinoz-details.js"></script>
</body>
</html>