// Connexion à la base de données
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Générateur de client pour le code JS
generator client {
  provider = "prisma-client-js"
}

// Table des Utilisateurs
model User {
  id           Int      @id @default(autoincrement())
  pseudo       String   @unique
  passwordHash String
  role         String   @default("MEMBRE") // "LEADER", "CHEF-ADJOINT" ou "MEMBRE"
  firstLogin   Boolean  @default(true)
  createdAt    DateTime @default(now())
  
  // Relation : Un user a plusieurs Dinozs
  dinozs       Dinoz[]

  // Préférence pour affichage des arbres
  treeMode     String   @default("COMPRESSED") // "COMPRESSED" ou "EXPANDED"

  // Relation inverse : Un user a créé plusieurs plans
  skillPlans   SkillPlan[]
}


// Table des Dinozs
model Dinoz {
  id        Int     @id @default(autoincrement())
  name      String
  race      String
  imageUrl  String?
  level     Int     @default(1)
  notes     String?
  
// Stats
  statFire  Int     @default(0)
  statWood  Int     @default(0)
  statWater Int     @default(0)
  statBolt  Int     @default(0)
  statAir   Int     @default(0)

// Compteurs de Sphères (0 à 3)
  sphereFire    Int @default(0)
  sphereWood    Int @default(0)
  sphereWater   Int @default(0)
  sphereBolt    Int @default(0)
  sphereAir     Int @default(0)
  sphereVoid    Int @default(0)

// Stats Générales
  statLife       Int @default(100)
  statSpeed      Int @default(10)
  statInitiative Int @default(0)
  statCounter    Int @default(0)
  statDodge      Int @default(0)
  statArmor      Int @default(0)

// Propriétaire
  userId    Int
  user      User    @relation(fields: [userId], references: [id])
  
// 1. Compétences Apprises
  learnedSkills   RefSkill[] @relation("LearnedSkills")
// 2. Compétences Débloquées (Disponibles)
  unlockedSkills  RefSkill[] @relation("UnlockedSkills")

// Historique des ups (JSON)
  ups       Json? 

// Dinoz Récincarné ? -- 1 pour oui -- 0 pour non
  isReincarnate   Int @default(0)

  planId    Int?         // Peut être null (pas de plan)
  plan      SkillPlan?   @relation(fields: [planId], references: [id])
}

// Table de Référence des Compétences (L'arbre)
model RefSkill {
  id          Int     @id 
  name        String  @unique
   
  // Infos générales
  type        String? // "A", "E", "P", "C", "S", "U"
  element     String? // "Feu", "Bois"...
  // 1 = Normal, 2 = Arbre 2, 3 = Sphère
  skillNature Int     @default(1)
  description String?
  raceId      String? // Ex: "Wanwan", "Kabuki", ou null
  
  // Stats techniques
  energy      Int?    @default(0)
  probability Int?    @default(0)
  priority    Int?    @default(0)
 
  // Relations inverses vers les Dinozs
  dinozsLearned   Dinoz[] @relation("LearnedSkills")
  dinozsUnlocked  Dinoz[] @relation("UnlockedSkills")
 
  // --- RELATION PARENT/ENFANT (Arbre de compétences) ---
  // On supprime "parentSkillId" !
  // On met des crochets [] des deux côtés pour dire "Plusieurs parents possibles"
  parents      RefSkill[] @relation("SkillTree")
  children     RefSkill[] @relation("SkillTree")
}

// Plans de Compétences (Architecte)
model SkillPlan {
  id        Int      @id @default(autoincrement())
  name      String
  race      String   
  level     Int      @default(1) 
  
  // Contenu du plan : Liste des IDs des compétences sélectionnées
  // Ex: [1, 4, 12, 105]
  skillIds  Json     

  isPublic  Boolean  @default(false) // false = Privé, true = Visible par le clan
  createdAt DateTime @default(now())

  // Auteur du plan
  authorId  Int
  originalAuthor String?
  author    User     @relation(fields: [authorId], references: [id])

  dinozs    Dinoz[]
}